<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì†Œìˆ˜ì˜ ë‚˜ëˆ—ì…ˆ ë ˆë²¨ì—… RPG</title>
  <style>
    :root{
      --bg:#0f1226; --panel:#171b39; --ink:#e8ecff; --sub:#9aa3d0;
      --accent:#6ae3ff; --good:#3ce27a; --bad:#ff6b6b; --rare:#b794f4; --legend:#ffd166; --myth:#ff7de9; --unique:#6aff6a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,Apple SD Gothic Neo,Arial,sans-serif;color:var(--ink);background:radial-gradient(1200px 600px at 70% -10%,#223 0%, #101325 55%, #0b0e1c 100%), var(--bg);}    
    .wrap{height:100vh;max-width:1180px;margin:0 auto;padding:16px;display:grid;grid-template-rows:auto 1fr}
    header{display:flex;align-items:center;gap:12px}
    h1{font-size:18px;margin:0;font-weight:800;letter-spacing:0.2px}
    .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);font-size:12px;color:var(--sub)}
    .layout{display:grid;grid-template-columns: 380px 1fr; gap:12px; min-height:0}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px;min-height:0}
    .title{font-size:13px;color:var(--sub);margin-bottom:8px;letter-spacing:.2px}
    .row{display:flex;gap:10px;align-items:center}
    .bar{height:12px;background:#0d1125;border:1px solid rgba(255,255,255,.08);border-radius:999px;overflow:hidden}
    .bar>span{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#7bffea)}
    .hp>span{background:linear-gradient(90deg,#ff7a7a,#ffb3a7)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .big{font-size:24px;font-weight:800}
    .muted{color:var(--sub)}
    button{border:none;background:linear-gradient(180deg,#2b2f58,#1d2144);border:1px solid rgba(255,255,255,.12);color:var(--ink);padding:8px 10px;border-radius:10px;font-weight:700;cursor:pointer}
    button:hover{filter:brightness(1.08)}
    button:active{transform:translateY(1px)}
    .btn-ghost{background:transparent;border:1px dashed rgba(255,255,255,.18)}
    .btn-good{background:linear-gradient(180deg,#2a6d46,#1a4d33)}
    .btn-bad{background:linear-gradient(180deg,#6d2a2a,#4d1a1a)}
    input[type=text]{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.16);background:#0e1230;color:var(--ink);font-size:16px}
    kbd{background:#0d1230;border:1px solid rgba(255,255,255,.18);padding:2px 6px;border-radius:6px;color:var(--sub)}
    .monster{display:flex;align-items:center;gap:12px}
    .monster .emoji{font-size:28px}
    .weapon{display:flex;align-items:center;gap:8px;padding:6px;border-radius:10px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08)}
    .weapon .tag{font-size:11px;color:#111;border-radius:999px;padding:2px 8px}
    .r-rare{background:var(--rare);} .r-legend{background:var(--legend);} .r-myth{background:var(--myth);} .r-unique{background:var(--unique)}
    .inv{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;overflow:auto;max-height:180px}
    .note{font-size:12px;color:var(--sub)}
    .problem{font-size:20px;font-weight:800;letter-spacing:.2px}
    .hint{font-size:13px;color:var(--accent);}
    .log{height:140px;overflow:auto;background:#0d1026;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:8px;font-size:12px}
    .range{font-size:12px;color:var(--sub)}
    .small{font-size:12px}
    .lives{display:flex;gap:6px}
    .equipSlot{display:grid;grid-template-columns:1fr 1fr;gap:6px}
    .boss{filter:drop-shadow(0 0 10px #ffcf66aa)}
    .rightCol{display:grid;grid-template-rows:auto auto 1fr; gap:10px; min-height:0}
    .footer{font-size:11px;color:var(--sub);opacity:.8}
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:50}
    .overlay .panel{background:#0f1230;border:1px solid rgba(255,255,255,.2);padding:18px;border-radius:12px;max-width:720px}
  .steps{display:flex;gap:6px;margin:8px 0 0;padding:0;list-style:none}
    .steps li{flex:1;text-align:center;font-size:12px;color:var(--sub);padding:6px 0;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:#0e1230}
    .steps li.active{background:linear-gradient(180deg,#2b2f58,#1d2144);color:#fff;border-color:rgba(255,255,255,.3);font-weight:800}
  .stageBanner{margin:10px 0;padding:14px 18px;border-radius:12px;font-size:18px;font-weight:900;letter-spacing:.3px;text-align:center;
      background:linear-gradient(90deg,#6ae3ff,#7bffea,#ffd166);color:#0b0e1c;
      border:1px solid rgba(255,255,255,.25);box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .stageBanner .minor{font-weight:700;opacity:.9}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ì†Œìˆ˜ì˜ ë‚˜ëˆ—ì…ˆ: ì“°ëŸ¬ëœ¨ë¦¬ê³  ë ˆë²¨ì—…!</h1>
      <span class="pill" id="modePill">ì˜¤í”„ë¼ì¸ Â· ë‹¨ì¼ HTML Â· ìë™ ì €ì¥</span>
      <button class="btn-ghost" id="btnRange">ë¬¸ì œ ë²”ìœ„</button>
      <button class="btn-ghost" id="btnTests">ê°œë°œì í…ŒìŠ¤íŠ¸</button>
      <button class="btn-ghost" id="btnReset">ì´ˆê¸°í™”</button>
    </header>

    <!-- âœ… ìƒë‹¨ ìŠ¤í…Œì´ì§€ ë°°ë„ˆ -->
    <div id="stageBanner" class="stageBanner">[ìŠ¤í…Œì´ì§€ 1-1 ìë¦¿ìˆ˜ê°€ ê°™ì€ ì†Œìˆ˜ì˜ ë‚˜ëˆ—ì…ˆ]</div>

    <!-- ğŸ”— ê³µìœ /ë­í‚¹ íŒ¨ë„ -->
    <section class="card" style="margin:10px 0; display:grid; grid-template-columns:1fr auto auto; gap:8px; align-items:end">
      <div>
        <div class="title">ë‚´ ì´ë¦„</div>
        <input id="nameInput" type="text" placeholder="ì˜ˆ: ê¹€ë¯¼ì¤€" />
      </div><div style="display:flex; gap:8px">
        <button id="btnSendScore" class="btn-good">ì ìˆ˜ ì „ì†¡</button>
        <button id="btnFetchRank" class="btn-ghost">ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      </div>
      <div class="note" id="shareNote">ì˜¨ë¼ì¸ ëª¨ë“œ ì„¤ì • í•„ìš”: ì½”ë“œ ìƒë‹¨ URL ìƒìˆ˜ ì„¤ì •</div>
    </section>


    <div class="layout">
<section class="card playerCard">
  <div class="title">í”Œë ˆì´ì–´</div>

  <!-- 2ì—´ ë ˆì´ì•„ì›ƒ -->
  <div class="playerWrap">
    <!-- ì™¼ìª½: í”Œë ˆì´ì–´ ì •ë³´ -->
    <div class="playerInfo">
      <div class="grid2">
        <div>
          <div class="muted small">ë ˆë²¨</div>
          <div class="big" id="level">1</div>
        </div>
        <div></div>
      </div>

      <!-- ê²½í—˜ì¹˜ -->
      <div class="muted small">ê²½í—˜ì¹˜</div>
      <div class="bar"><span id="xpbar" style="width:0%"></span></div>
      <div class="small muted" id="xpText">ë‹¤ìŒ ë ˆë²¨ê¹Œì§€ 0 XP (0%)</div>

      <!-- HP -->
      <div class="muted small">HP</div>
      <div class="bar hp"><span id="hpbar" style="width:100%"></span></div>
      <div class="small" id="hpText">100 / 100</div>

      <!-- ê³µê²©ë ¥Â·ìŠ¤í…Œì´ì§€ -->
      <div class="row" style="justify-content:space-between; margin-top:8px; white-space:nowrap">
        <div class="muted small">
          ê³µê²©ë ¥ <span class="big" id="atk">5</span> Â· ìŠ¤í…Œì´ì§€ <strong id="stage">1-1</strong>
        </div>
        <div class="lives" id="lives"></div>
      </div>

      <!-- ìŠ¤í…Œì´ì§€ ì§„í–‰ -->
      <ul id="stageSteps" class="steps" aria-label="ìŠ¤í…Œì´ì§€ ì§„í–‰">
        <li>1</li><li>2</li><li>3</li><li>4</li><li>5</li>
      </ul>
    </div>

    <!-- ì˜¤ë¥¸ìª½: ì „íˆ¬ ë¡œê·¸ -->
    <div class="playerLog">
      <div class="title">ì „íˆ¬ ë¡œê·¸</div>
      <div id="log" class="log log-resp"></div>
    </div>
  </div>
</section>

      </section>
      <section class="card rightCol">
        <div>
          <div class="title">ì „íˆ¬</div>
          <div class="monster">
            <div class="emoji" id="mobEmoji">ğŸ‘¾</div>
            <div style="flex:1">
              <div class="row" style="justify-content:space-between">
                <div class="muted"><span id="bossMark"></span>Lv.<span id="mobLv">1</span> <strong id="mobName">ì†Œìˆ˜ ìŠ¬ë¼ì„</strong></div>
                <div class="muted">HP <span id="mobHpText">20</span></div>
              </div>
              <div class="bar hp"><span id="mobHpBar" style="width:100%"></span></div>
            </div>
          </div>
        </div>

        <div>
          <div class="title">ë¬¸ì œ</div>
          <div class="problem" id="question">ë¬¸ì œ ì¤€ë¹„ ì¤‘â€¦</div>
          <div class="row" style="margin-top:10px; gap:8px">
            <input type="text" id="answer" placeholder="ë‹µ ì…ë ¥ (ì˜ˆ: 1.5, 0.75, 2.4 / ë˜ëŠ” 10, 0.6)" />
            <button id="btnCheck" class="btn-good">ì •ë‹µ!</button>
            <button id="btnHint" class="btn-ghost">íŒíŠ¸</button>
            <button id="btnSkip" class="btn-bad">ê±´ë„ˆë›°ê¸°</button>
          </div>
          <div class="hint" id="hint"></div>
       </div>
        <div>
        <div class="card" style="grid-column:1 / -1">
        <div class="title">ë­í‚¹</div>
        <div id="rankingModal" class="log" style="height:auto; max-height:160px; overflow:auto"></div>
        <div>
    </div>



  <!-- ë²”ìœ„/í…ŒìŠ¤íŠ¸/ê²Œì„ì˜¤ë²„ ì˜¤ë²„ë ˆì´ -->
  <div class="overlay" id="ovRange">
    <div class="panel">
      <h3>ë¬¸ì œ ë²”ìœ„ (6í•™ë…„ 2í•™ê¸° 2ë‹¨ì› ì†Œìˆ˜ì˜ ë‚˜ëˆ—ì…ˆ)</h3>
      <ul>
        <li>â‘  ìë¦¿ìˆ˜ê°€ ê°™ì€ ì†Œìˆ˜ì˜ ë‚˜ëˆ—ì…ˆ</li>
        <li>â‘¡ ìë¦¿ìˆ˜ê°€ ë‹¤ë¥¸ ì†Œìˆ˜ì˜ ë‚˜ëˆ—ì…ˆ</li>
        <li>â‘¢ ìì—°ìˆ˜ ë‚˜ëˆ„ê¸° ì†Œìˆ˜</li>
        <li>â‘£ ëª«ì„ ë°˜ì˜¬ë¦¼í•˜ì—¬ ë‚˜íƒ€ë‚´ê¸°(ì²«ì§¸/ë‘˜ì§¸/ì¼ì˜ìë¦¬)</li>
        <li>â‘¤ ë‚˜ëˆ ì£¼ê³  ë‚¨ëŠ” ì–‘ êµ¬í•˜ê¸°</li>
      </ul>
      <div style="text-align:right;margin-top:10px"><button id="closeRange">ë‹«ê¸°</button></div>
    </div>
  </div>

  <div class="overlay" id="ovTests">
    <div class="panel">
      <h3>ê°œë°œì í…ŒìŠ¤íŠ¸</h3>
      <pre id="testOut" style="white-space:pre-wrap;background:#101431;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.08)">ì•„ì§ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</pre>
      <div style="text-align:right;margin-top:10px"><button id="btnRunTests">í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button> <button id="closeTests">ë‹«ê¸°</button></div>
    </div>
  </div>

  <div class="overlay" id="gameover">
    <div class="panel">
      <h3>ê²Œì„ ì˜¤ë²„</h3>
      <p class="muted">ëª©ìˆ¨ì„ ëª¨ë‘ ì†Œì§„í–ˆìŠµë‹ˆë‹¤. ì²˜ìŒë¶€í„° ë‹¤ì‹œ ë„ì „!</p>
      <div class="row" style="justify-content:flex-end;gap:8px"><button id="btnRestart">ì²˜ìŒë¶€í„°</button></div>
    </div>
  </div>

  <div class="overlay" id="victory">
    <div class="panel">
      <h3>ğŸ‰ ê²©íŒŒ ì„±ê³µ!</h3>
      <p id="victoryText" class="muted">ëª¬ìŠ¤í„°ë¥¼ ì²˜ì¹˜í–ˆìŠµë‹ˆë‹¤.</p>
      <div class="row" style="justify-content:flex-end;gap:8px"><button id="btnVictoryClose">ê³„ì†</button></div>
    </div>
  </div>
    </div>
  </div>

  <script>
  'use strict';
  const $ = (s)=>document.querySelector(s);
  const clamp=(x,a,b)=>Math.min(b,Math.max(a,x));
  function setText(sel,t){const el=$(sel); if(el) el.textContent=t;}
  function setWidth(sel,p){const el=$(sel); if(el) el.style.width=p;}
  function openOverlay(id){const el=document.getElementById(id); if(el) el.style.display='flex';}
  function closeOverlay(id){const el=document.getElementById(id); if(el) el.style.display='none';}
  function log(msg){const el=$('#log'); const time=new Date().toLocaleTimeString(); if(el){el.innerHTML='['+time+'] '+msg+'<br>'+el.innerHTML;}}
  function rnd(a,b){return Math.floor(Math.random()*(b-a+1))+a}
  function toFixedTrim(x,k){const s=x.toFixed(k);return s.replace(/\.?0+$/,'');}
  function decToFracParts(str){if(!/^-?\d+(?:\.\d+)?$/.test(str)) return null; if(!str.includes('.')) return [parseInt(str,10),1]; const neg=str.startsWith('-'); const s=neg?str.slice(1):str; const [A,B]=s.split('.'); const d=10**B.length; const n=parseInt(A,10)*d+parseInt(B,10); return [neg?-n:n,d];}
  function randDec(places=2){ if(places===1){return (rnd(1,99)/10).toFixed(1);} return (rnd(1,999)/100).toFixed(2);} 
  function pick(arr){return arr[Math.floor(Math.random()*arr.length)];}
  // ìƒˆë¡œ ì¶”ê°€: í‘œì‹œìš©ìœ¼ë¡œ ë 0ì„ ì œê±°í•œ ë¬¸ìì—´ê³¼, ì œê±° í›„ ìë¦¬ìˆ˜ ê³„ì‚°
  function trimZerosStr(s){
    if(!s.includes('.')) return s;
    // ì†Œìˆ˜ì  ë’¤ ë¶ˆí•„ìš”í•œ 0 ì œê±° (ex: 0.40 -> 0.4, 2.50 -> 2.5, 3.00 -> 3)
    return s.replace(/0+$/,'').replace(/\.$/, '');
  }
  function decPlacesTrimmed(s){
    const m = String(s).split('.'); if(m.length<2) return 0; return m[1].replace(/0+$/,'').length;
  }
  // í‘œì‹œì— ì“°ëŠ” ê³µí†µ í¬ë§·í„°: ìˆ«ì/ë¬¸ì ëª¨ë‘ ë 0 ì œê±°í•œ ë¬¸ìì—´ë¡œ ë°˜í™˜
  function fmt(x){ return trimZerosStr(String(x)); }
  function atMostKDecimals(val,k){ const m=Math.pow(10,k); return Math.abs(Math.round(val*m) - val*m) < 1e-9; }

  // âœ… ì •ë‹µ ëª©í‘œ ì„¤ì •
  const STAGE_GOAL=2;
  
  const state={level:1,xp:0,maxHp:20,hp:20,baseAtk:5,lives:1,stage:{world:1,index:1,correct:0},mob:null,problem:null,freeplay:false};

  function needXpFor(lv){return 50+(lv-1)*25}
  function totalAtk(){return state.baseAtk+(state.level-1)*2}

  function newMonster(){const lv=state.level+(state.stage.world-1); const namePool=['ì†Œìˆ˜ ìŠ¬ë¼ì„','ë‚˜ëˆ—ì…ˆ ë‹¬íŒ½ì´','ë°˜ì˜¬ë¦¼ ê´´ë¬¼','ë‚˜ë¨¸ì§€ ì„í”„','ëª« ë„ë‘‘','ë¶„ëª¨ íŒŒê´´ì','ì†Œìˆ˜ì  ìŠ¬ë¼ì„','ì œë¡œìŠˆê°€ ìŠ¬ë¼ì„','í”„ë¼ì„ ë¼ì§€','ë‚˜ëˆ—ì…ˆ ëª»í•¨ì´','ì†Œìˆ˜ ìš©','ê³±í•˜ê¸° ë²Œë ˆ','ëª«ì´ ì—†ì¥','ì†Œìˆ˜ì™•ì 7ì„¸','ë‚˜ëˆ—ì…ˆ ë§ˆì™•']; const mhp=lv<4?rnd(12,18):(lv<8?rnd(22,34):rnd(40,60)); const atk=lv<4?rnd(2,4):(lv<8?rnd(4,7):rnd(7,11)); state.mob={name:pick(namePool),level:lv,maxHp:mhp,hp:mhp,atk,boss:false,emoji:'ğŸ‘¾'}; setText('#mobName',state.mob.name); setText('#mobLv',lv); setText('#mobHpText',state.mob.hp); setWidth('#mobHpBar',(state.mob.hp/state.mob.maxHp*100).toFixed(1)+'%'); $('#mobEmoji').textContent='ğŸ‘¾'; setText('#bossMark',''); renderBars();}

function renderBars(){ 
  let stageTxt = state.stage.world+'-'+state.stage.index+' (ì •ë‹µ '+state.stage.correct+'/'+STAGE_GOAL+')';
  if(state.freeplay) stageTxt = 'ììœ  ì—°ìŠµ ëª¨ë“œ';
  setText('#stage',stageTxt);

  // HP ë°”ì™€ ìˆ«ì
  setWidth('#hpbar', (state.hp/state.maxHp*100).toFixed(1)+'%');
  setText('#hpText', state.hp + ' / ' + state.maxHp);


  // XP ë°”
const need = needXpFor(state.level);
const pct  = Math.min(100, state.xp/need*100);
setWidth('#xpbar', pct.toFixed(1)+'%');
setText('#xpText', `ë‹¤ìŒ ë ˆë²¨ê¹Œì§€ ${Math.max(0, Math.ceil(need - state.xp))} XP (${Math.floor(pct)}%)`);

  
  // ë ˆë²¨, ê³µê²©ë ¥
  setText('#level',state.level);
  setText('#atk',totalAtk());

  // ë‚¨ì€ ëª©ìˆ¨
  const lives=$('#lives');
  if(lives){
    lives.innerHTML='';
    for(let i=0;i<state.lives;i++){
      const s=document.createElement('span');
      s.textContent='â¤';
      lives.appendChild(s);
    }
  }

  renderStageSteps();
  updateStageBanner();
}

  function gainXp(x){state.xp+=x; log('ê²½í—˜ì¹˜ +'+x); while(state.xp>=needXpFor(state.level)){state.xp-=needXpFor(state.level); state.level++; state.maxHp+=12; state.hp=Math.min(state.maxHp,state.hp+20); log('<strong>ë ˆë²¨ ì—…!</strong> í˜„ì¬ ë ˆë²¨ '+state.level);} renderBars();}

  // ìœ í•œì†Œìˆ˜ ë³´ì¥ ë„ìš°ë¯¸ (ë°˜ì˜¬ë¦¼í˜• ì œì™¸)
  function ensureTerminating(nStr, dStr){
    for(let t=0;t<200;t++){
      const A=decToFracParts(nStr); const B=decToFracParts(dStr);
      if(!A||!B){ dStr=randDec(1); continue; }
      const an=A[0],ad=A[1], bn=B[0],bd=B[1]; if(bn===0){ dStr=randDec(1); continue; }
      const N=an*bd, D=ad*bn; // an/ad Ã· bn/bd = an*bd / ad*bn
      const g=(a,b)=>b?g(b,a%b):a; const gg=g(Math.abs(N),Math.abs(D));
      let x=Math.abs(D/gg); while(x%2===0) x/=2; while(x%5===0) x/=5;
      if(x===1) return [nStr,dStr];
      // ì œìˆ˜ë¥¼ 2,5 ì†Œì¸ìˆ˜ë¡œë§Œ ë§Œë“œëŠ” ë°©í–¥ìœ¼ë¡œ ì¡°ì • (10 ë˜ëŠ” 100ì˜ ì•½ìˆ˜)
      const pow10=pick([1,2]); const base=Math.pow(10,pow10); const mul=pick([2,4,5,8,10,20,25,40,50]);
      dStr=(mul/base).toFixed(pow10);
    }
    return [nStr,dStr];
  }

  // ë¬¸ì œ ìƒì„±ê¸°
  function makeProblemByStage(){
    // ì•ˆì „ ê°€ë“œ: ìŠ¤í…Œì´ì§€ ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ë©´ 1ë¡œ ë³´ì •
    if(!state.stage || !state.stage.index || state.stage.index<1 || state.stage.index>5){ state.stage={world:1,index:1,correct:0}; }
    const idx = state.freeplay ? pick([1,2,3,4,5]) : state.stage.index;
    let text='', ans=null, hint='', kind='number';

    const MAX_OUTER=300; let outer=0;
    while(outer++<MAX_OUTER){
      if(idx===1){
        const places = pick([1,2]);
        let a,b,av,bv; let tries=0;
        while(tries++<160){
          a = trimZerosStr(randDec(places)); b = trimZerosStr(randDec(places));
          ;[a,b] = ensureTerminating(a,b);
          a = trimZerosStr(a); b = trimZerosStr(b);
          const da=decPlacesTrimmed(a), db=decPlacesTrimmed(b);
          if(da>0 && da===db){
            av=parseFloat(a); bv=parseFloat(b);
            const q=av/bv; if(isFinite(q) && atMostKDecimals(q,2)){
              text = fmt(a)+' Ã· '+fmt(b); ans = q; hint='ê°™ì€ ìë¦¬ìˆ˜(ë 0 ì œì™¸) â†’ ì†Œìˆ˜ì  ë™ì‹œì— ì˜¤ë¥¸ìª½ ì´ë™'; kind='number';
              return {text, ans, hint, kind};
            }
          }
        }
      }
      else if(idx===2){
        let a,b,av,bv; let tries=0; const banned=new Set(['0.1','0.01']);
        while(tries++<240){
          a = trimZerosStr(randDec(pick([1,2])));
          b = trimZerosStr(randDec(pick([1,2])));
          if(Math.random()<0.5){ const t=a; a=b; b=t; }
          ;[a,b] = ensureTerminating(a,b);
          a = trimZerosStr(a); b = trimZerosStr(b);
          const da=decPlacesTrimmed(a), db=decPlacesTrimmed(b);
          if(da!==db && da>0 && db>0 && !banned.has(b)){
            av=parseFloat(a); bv=parseFloat(b);
            const q=av/bv; if(isFinite(q) && atMostKDecimals(q,2)){
              text = fmt(a)+' Ã· '+fmt(b); ans = q; hint='ì œìˆ˜ë¥¼ ì •ìˆ˜ë¡œ ë§Œë“¤ê¸° ìœ„í•´ ë‘˜ ë‹¤ ê°™ì€ ë§Œí¼ ê³±í•˜ê¸°(ë 0 ì œì™¸ ê¸°ì¤€)'; kind='number';
              return {text, ans, hint, kind};
            }
          }
        }
      }
      else if(idx===3){
        let A,b,av,bv; let tries=0;
        while(tries++<160){
          A = String(rnd(2,50)); b = trimZerosStr(randDec(pick([1,2])));
          ;[A,b] = ensureTerminating(String(A), b);
          b = trimZerosStr(b);
          av=parseFloat(A); bv=parseFloat(b);
          const q=av/bv; if(isFinite(q) && atMostKDecimals(q,2)){
            text = fmt(A)+' Ã· '+fmt(b); ans=q; hint='ì œìˆ˜ë¥¼ ì •ìˆ˜ë¡œ ë°”ê¾¸ê¸° (ë‘˜ ë‹¤ Ã—10 ë˜ëŠ” Ã—100)'; kind='number';
            return {text, ans, hint, kind};
          }
        }
      }
      else if (idx === 4) {
  // ë°˜ì˜¬ë¦¼ ì§‘ì¤‘í˜•: ì˜ˆ) 3.5 Ã· 9, 7.2 Ã· 8, 4.0 Ã· 3
  const a = (rnd(10, 99) / 10).toFixed(1); // 1.0 ~ 9.9 (ì†Œìˆ˜ ì²«ì§¸ìë¦¬)
  const b = String(rnd(2, 9));             // 2 ~ 9 (ì •ìˆ˜ í•œ ìë¦¬)

  const target = pick(['ì†Œìˆ˜ ì²«ì§¸ìë¦¬', 'ì†Œìˆ˜ ë‘˜ì§¸ìë¦¬', 'ì¼ì˜ìë¦¬']);
  const text = fmt(a) + ' Ã· ' + fmt(b) + ' (ëª«ì„ ë°˜ì˜¬ë¦¼í•˜ì—¬' + target + 'ê¹Œì§€ ë‚˜íƒ€ë‚´ê¸°)';
  const raw = parseFloat(a) / parseFloat(b);
  const kind = 'rounding';
  const ans = { raw, target };
  const hint = 'ë³µì¡í•œ ê³„ì‚°ë³´ë‹¤ ë°˜ì˜¬ë¦¼ ê·œì¹™ì— ì§‘ì¤‘: 5ì´ìƒ ì˜¬ë¦¼, ë¯¸ë§Œ ë²„ë¦¼';

  return { text, ans, hint, kind };
}
      else { // 5: ë‚˜ëˆ ì£¼ê³  ë‚¨ëŠ” ì–‘ â€” ë°˜ë“œì‹œ ëª« â‰¥ 2
  let tries = 0;
  while (tries++ < 300) {
    let X = trimZerosStr((rnd(12,200)/10).toFixed(pick([1,2])));
    let Y = trimZerosStr((rnd(5,150)/10).toFixed(pick([1,2])));
    const xv = parseFloat(X), yv = parseFloat(Y);
    if (yv <= 0) continue;
    const cnt = Math.floor((xv + 1e-9) / yv);
    if (cnt >= 2) {
      const remain = xv - cnt * yv;
      const rFixed = Math.round(remain * 100) / 100;
      const text = fmt(X) + 'ë¥¼ ' + fmt(Y) + 'ì”© ë‚˜ëˆ„ì–´ ë‹´ìŠµë‹ˆë‹¤. ë§Œë“¤ ìˆ˜ ìˆëŠ” ê°œìˆ˜ì™€ ë‚¨ëŠ” ì–‘ì€? (í˜•ì‹: ê°œìˆ˜, ë‚¨ëŠ”ì–‘)';
      const ans = { cnt, rem: rFixed };
      const hint = 'ê°œìˆ˜ = ëª«ì˜ ì •ìˆ˜ë¶€ë¶„, ë‚¨ëŠ” ì–‘ = ì „ì²´ - (ê°œìˆ˜Ã—í•œ ê°œ ë¶„ëŸ‰)';
      const kind = 'pair';
      return { text, ans, hint, kind };
    }
  }
  // ì•ˆì „ í´ë°±
  const X = '6.0', Y = '2.5';
  const xv = 6.0, yv = 2.5;
  const cnt = Math.floor((xv + 1e-9) / yv);
  const rFixed = Math.round((xv - cnt * yv) * 100) / 100;
  const text = fmt(X)+'ë¥¼ '+fmt(Y)+'ì”© ë‚˜ëˆ„ì–´ ë‹´ìŠµë‹ˆë‹¤. ë§Œë“¤ ìˆ˜ ìˆëŠ” ê°œìˆ˜ì™€ ë‚¨ëŠ” ì–‘ì€? (í˜•ì‹: ê°œìˆ˜, ë‚¨ëŠ”ì–‘)';
  const ans = { cnt, rem: rFixed };
  const hint = 'ê°œìˆ˜ = ëª«ì˜ ì •ìˆ˜ë¶€ë¶„, ë‚¨ëŠ” ì–‘ = ì „ì²´ - (ê°œìˆ˜Ã—í•œ ê°œ ë¶„ëŸ‰)';
  const kind = 'pair';
  return { text, ans, hint, kind };
}

    }
    // í´ë°± (ì´ ì§€ì ì— ì˜¤ë©´ ì–´ë–¤ ê²½ìš°ë“  ì•ˆì „ ë¬¸ì œ ë°˜í™˜)
    return {text:'1.2 Ã· 0.3', ans:4, hint:'ì œìˆ˜ë¥¼ ì •ìˆ˜ë¡œ ë§Œë“¤ê¸°', kind:'number'};
  }

  // ====== ì±„ì  ======
  function parseNumberInput(s){ s=(s||'').trim().replace(/\s+/g,''); if(!s) return null; if(!/^[-+]?\d*(?:\.\d+)?$/.test(s)) return null; return parseFloat(s); }
  function checkAnswer(){
    const p = state.problem; const inp = $('#answer'); const v = inp? inp.value: '';
    if(!p){ log('ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

    // í‘œì¤€ ë¹„êµ ë„ìš°ë¯¸: ì›í•˜ëŠ” ìë¦¬ê¹Œì§€ ë°˜ì˜¬ë¦¼ í›„ ë¶ˆí•„ìš”í•œ 0 ì œê±° ë¬¸ìì—´ë¡œ ë¹„êµ
    const canon = (x,k=2)=> toFixedTrim(parseFloat(x), k);

    // â‘¤ ë‚˜ëˆ ì£¼ê³  ë‚¨ëŠ” ì–‘ (í˜•ì‹: ê°œìˆ˜, ë‚¨ëŠ”ì–‘)
    if(p.kind==='pair'){
      const m = v.split(','); if(m.length!==2){ log('í˜•ì‹: ê°œìˆ˜, ë‚¨ëŠ”ì–‘  (ì˜ˆ: 10, 0.6)'); return; }
      const a = parseInt(m[0].trim(),10); const b = parseNumberInput(m[1]);
      if(Number.isNaN(a) || b==null){ log('í˜•ì‹: ê°œìˆ˜, ë‚¨ëŠ”ì–‘  (ì˜ˆ: 10, 0.6)'); return; }
      const ok = (a===p.ans.cnt) && (canon(b,2) === canon(p.ans.rem,2));
      finalize(ok, ok? 'ì •ë‹µ! ('+p.ans.cnt+', '+canon(p.ans.rem,2)+')':'ì˜¤ë‹µ! ì •ë‹µì€ '+p.ans.cnt+', '+canon(p.ans.rem,2));
      return;
    }

    // â‘£ ë°˜ì˜¬ë¦¼ ì±„ì  (ì¼ì˜ìë¦¬/ì²«ì§¸/ë‘˜ì§¸)
    if(p.kind==='rounding'){
      const target = p.ans.target;
// 'ì†Œìˆ˜ ì²«ì§¸ìë¦¬' / 'ì†Œìˆ˜ ë‘˜ì§¸ìë¦¬' / 'ì¼ì˜ìë¦¬' ëª¨ë‘ ì§€ì›
const want = target.includes('ë‘˜ì§¸') ? 2 : (target.includes('ì²«ì§¸') ? 1 : -1);
      const inNum = parseNumberInput(v); if(inNum==null){ log('ìˆ«ìë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
      if(want===-1){
        const correct = Math.round(p.ans.raw);
        const ok = Math.abs(inNum - correct) < 1e-9;
        finalize(ok, ok? 'ì •ë‹µ! '+correct : 'ì˜¤ë‹µ! ì •ë‹µì€ '+correct);
      } else {
        const factor = Math.pow(10, want);
        const correctVal = Math.round(p.ans.raw * factor)/factor;
        const ok = (canon(inNum, want) === canon(correctVal, want));
        finalize(ok, ok? 'ì •ë‹µ! '+canon(correctVal, want) : 'ì˜¤ë‹µ! ì •ë‹µì€ '+canon(correctVal, want));
      }
      return;
    }

    // ì¼ë°˜ ìˆ«ì ë¬¸ì œ (â‘ â‘¡â‘¢): ì†Œìˆ˜ ë‘˜ì§¸ìë¦¬ê¹Œì§€ í‘œì¤€ ë¬¸ìì—´ ë¹„êµ
    const num = parseNumberInput(v); if(num==null){ log('ìˆ«ìë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
    const ok = (canon(num,2) === canon(p.ans,2));
    finalize(ok, ok? 'ì •ë‹µ! '+canon(p.ans,2): 'ì˜¤ë‹µ! ì •ë‹µì€ '+canon(p.ans,2));
  }

  function damageToMonster(ok){
    if(ok){
      const base=totalAtk();
      const crit=Math.random()<0.1;
      const dmg=crit?Math.round(base*1.6):base;
      state.mob.hp=Math.max(0, state.mob.hp-dmg);
      setText('#mobHpText', state.mob.hp);
      setWidth('#mobHpBar', (state.mob.hp/state.mob.maxHp*100).toFixed(1)+'%');
      log('ì •ë‹µ! '+dmg+' í”¼í•´'+(crit?' (ì¹˜ëª…íƒ€)':'')+'.');
      if(state.mob.hp===0){
        const killedName = state.mob.name;
        gainXp(25+state.mob.level*8);
        const msg = `<strong>${killedName}</strong> ê²©íŒŒ! ë³´ìƒìœ¼ë¡œ ê²½í—˜ì¹˜ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.`;
        const vt = document.getElementById('victoryText'); if(vt) vt.innerHTML = msg;
        state.victoryHold = true; // íŒì—… ë‹«ì„ ë•Œê¹Œì§€ ì§„í–‰ ë©ˆì¶¤
        openOverlay('victory');
        return; // ìƒˆ ëª¬ìŠ¤í„°/ë¬¸ì œëŠ” ë‹«ê¸° ë²„íŠ¼ì—ì„œ ì²˜ë¦¬
      }
    } else {
      const dmg=Math.max(1, state.mob.atk);
      state.hp=clamp(state.hp-dmg,0,state.maxHp);
      renderBars();
      log('ì˜¤ë‹µâ€¦ ë°˜ê²© '+dmg+' í”¼í•´');
      if(state.hp===0){ openOverlay('gameover'); }
    }
  }

  function nextProblem(){
    try{
      const p = makeProblemByStage();
      if(!p || !p.text) throw new Error('ë¹ˆ ë¬¸ì œ');
      state.problem = p;
      setText('#question', p.text);
      setText('#hint','');
      const a=$('#answer'); if(a) a.value='';
    }catch(e){
      log('nextProblem ì˜¤ë¥˜: '+(e?.message||e));
      // ì¦‰ì‹œ í´ë°± ë¬¸ì œ
      state.problem = { text:'1.2 Ã· 0.3', ans:4, hint:'ì œìˆ˜ë¥¼ ì •ìˆ˜ë¡œ ë§Œë“¤ê¸°', kind:'number' };
      setText('#question', state.problem.text);
      setText('#hint','');
      const a=$('#answer'); if(a) a.value='';
    }
  }

  function safeNextProblem(){
  try { nextProblem(); } catch (e) {
    log('ë¬¸ì œ ìƒì„± ì˜¤ë¥˜: '+(e?.message||e));
  }

  // ê°•ì œ í´ë°±: ì—¬ëŸ¬ ë²ˆ í™•ì¸í•´ì„œ "ë¬¸ì œ ì¤€ë¹„ ì¤‘â€¦"ì´ë©´ ì¦‰ì‹œ ëŒ€ì²´ ë¬¸ì œ ì„¸íŒ…
  const force = ()=>{
    const qEl = document.getElementById('question');
    const txt = (qEl?.textContent||'').trim();
    const needFallback =
      !state.problem || !state.problem.text ||
      !qEl || !txt || txt.includes('ë¬¸ì œ ì¤€ë¹„ì¤‘') || txt.includes('ë¬¸ì œ ì¤€ë¹„ ì¤‘');

    if (needFallback) {
      state.problem = { text:'1.2 Ã· 0.3', ans:4, hint:'ì œìˆ˜ë¥¼ ì •ìˆ˜ë¡œ ë§Œë“¤ê¸°', kind:'number' };
      setText('#question', state.problem.text);
      setText('#hint','');
      const a = document.querySelector('#answer'); if(a) a.value='';
      log('í´ë°± ë¬¸ì œ ê°•ì œ ì ìš©');
    }
  };

  setTimeout(force, 60);
  setTimeout(force, 200);
  setTimeout(force, 600);
  setTimeout(force, 1200);
}


  function finalize(correct, msg){
    log(msg);
    if(correct){
      state.stage.correct++;
      damageToMonster(true);
      if(state.victoryHold){ renderBars(); return; }
      if(!state.freeplay && state.stage.correct>=STAGE_GOAL){
        state.stage.correct=0; state.stage.index++;
        if(state.stage.index>5){
          state.stage.index=1; state.stage.world++;
          log('<strong>ì›”ë“œ ì—…!</strong>');
          state.freeplay=true;
          log('<strong>ì¶•í•˜í•©ë‹ˆë‹¤! ëª¨ë“  ìŠ¤í…Œì´ì§€ë¥¼ í´ë¦¬ì–´í–ˆìŠµë‹ˆë‹¤.</strong> ì´ì œ ììœ  ì—°ìŠµ ëª¨ë“œì—ì„œ ê³„ì† ë¬¸ì œë¥¼ í’€ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        } else {
          log('<strong>ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´!</strong> ë‹¤ìŒ ìŠ¤í…Œì´ì§€ë¡œ ì´ë™');
        }
      }
      renderBars();
      safeNextProblem();
    } else {
      damageToMonster(false);
      safeNextProblem();
    }
  }

  function bindUI(){
    const btnCheck=$('#btnCheck'); if(btnCheck) btnCheck.addEventListener('click', checkAnswer);
    const ans=$('#answer'); if(ans) ans.addEventListener('keydown', (e)=>{ if(e.key==='Enter') checkAnswer();});
    const btnSkip=$('#btnSkip'); if(btnSkip) btnSkip.addEventListener('click', ()=>{ log('ë¬¸ì œ ê±´ë„ˆë›°ê¸°'); safeNextProblem();});
    const btnRange=$('#btnRange'); if(btnRange) btnRange.addEventListener('click', ()=>openOverlay('ovRange'));
    const closeRange=$('#closeRange'); if(closeRange) closeRange.addEventListener('click', ()=>closeOverlay('ovRange'));
    const btnReset=$('#btnReset'); if(btnReset) btnReset.addEventListener('click', ()=>{ location.reload(); });
    const btnRestart=$('#btnRestart'); if(btnRestart) btnRestart.addEventListener('click', ()=>{ location.reload(); });
    const btnTests=$('#btnTests'); if(btnTests) btnTests.addEventListener('click', ()=>{ openOverlay('ovTests'); runTests(); });
    const closeTests=$('#closeTests'); if(closeTests) closeTests.addEventListener('click', ()=>closeOverlay('ovTests'));
    const btnRunTests=$('#btnRunTests'); if(btnRunTests) btnRunTests.addEventListener('click', runTests);
    const btnHint=$('#btnHint'); if(btnHint) btnHint.addEventListener('click', ()=>{ if(state.problem) setText('#hint', state.problem.hint);});
    const btnVictoryClose = document.getElementById('btnVictoryClose'); if(btnVictoryClose) btnVictoryClose.addEventListener('click', ()=>{ closeOverlay('victory'); state.victoryHold=false; newMonster(); renderBars(); nextProblem(); });
    const btnSend = $('#btnSendScore'); if (btnSend) btnSend.addEventListener('click', sendScore);

    // â¬‡â¬‡â¬‡ ì—¬ê¸° ì¶”ê°€ (ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ)
    const btnFetchRank = $('#btnFetchRank');
    if (btnFetchRank) btnFetchRank.addEventListener('click', async ()=>{
      openOverlay('ovRank');                       // ëª¨ë‹¬ ì—´ê¸°
      const rows = await fetchRanking();           // ì„œë²„/ë¡œì»¬ ë­í‚¹ ê°€ì ¸ì˜¤ê¸°
      renderRanking(rows, 'rankingModal');         // ëª¨ë‹¬ ë‚´ë¶€ í‘œì— ë Œë” (id=rankingModal)
    });

    // (ì„ íƒ) ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ ì—†ìœ¼ë©´ ê°™ì´ ì¶”ê°€
    const closeRank = $('#closeRank');
    if (closeRank) closeRank.addEventListener('click', ()=> closeOverlay('ovRank'));
  }

  // ê°„ë‹¨ í…ŒìŠ¤íŠ¸ ëŸ¬ë„ˆ (ê¸°ì¡´ ì„¤ëª… + ì¶”ê°€ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤)
  function runTests(){
    const out=$('#testOut'); if(!out) return;
    const lines=[];
    function assert(name, cond, detail=''){ lines.push((cond?'âœ… ':'âŒ ')+name+(detail? ' -> '+detail:'')); }

    // ê¸°ì¡´: ê·œì¹™ ì„¤ëª…
    lines.push('ìŠ¤í…Œì´ì§€ ê·œì¹™:');
    lines.push('1 ê°™ì€ ìë¦¬ ì†Œìˆ˜ Ã· ì†Œìˆ˜');
    lines.push('2 ë‹¤ë¥¸ ìë¦¬ ì†Œìˆ˜ Ã· ì†Œìˆ˜');
    lines.push('3 ìì—°ìˆ˜ Ã· ì†Œìˆ˜');
    lines.push('4 ë°˜ì˜¬ë¦¼');
    lines.push('5 ë‚˜ëˆ ì£¼ê³  ë‚¨ëŠ” ì–‘ (ì •ë‹µ í˜•ì‹: ê°œìˆ˜, ë‚¨ëŠ”ì–‘)');
    lines.push('\nì¶”ê°€ ìë™ í…ŒìŠ¤íŠ¸:');

    // 1) ìœ í•œì†Œìˆ˜ ë³´ì¥ í…ŒìŠ¤íŠ¸ ì—¬ëŸ¬ ê±´
    const pairs=[["4.56","1.52"],["2.1","3.12"],["12","1.5"],["7.5","0.25"],["0.4","0.2"]];
    for(const [a,b] of pairs){
      const [na,nb]=ensureTerminating(a,b);
      const A=decToFracParts(na), B=decToFracParts(nb);
      const N=A[0]*B[1], D=A[1]*B[0];
      const g=(x,y)=>y?g(y,x%y):x; let x=Math.abs(D/g(N,D)); while(x%2===0) x/=2; while(x%5===0) x/=5; assert(`ìœ í•œì†Œìˆ˜ ê²€ì‚¬ ${na} Ã· ${nb}`, x===1, `ë¶„ëª¨ ì†Œì¸ìˆ˜=${x}`);
    }

    // 2) ë°˜ì˜¬ë¦¼ ê·œì¹™ í…ŒìŠ¤íŠ¸
    const r1=Math.round(1.24*10)/10; assert('ë°˜ì˜¬ë¦¼ ì²«ì§¸ìë¦¬(1.24â†’1.2)', Math.abs(r1-1.2)<1e-9);
    const r2=Math.round(1.25*10)/10; assert('ë°˜ì˜¬ë¦¼ ì²«ì§¸ìë¦¬(1.25â†’1.3)', Math.abs(r2-1.3)<1e-9);
    const r3=Math.round(12.345*100)/100; assert('ë°˜ì˜¬ë¦¼ ë‘˜ì§¸ìë¦¬(12.345â†’12.35)', Math.abs(r3-12.35)<1e-9);

    // 3) ë‚¨ëŠ” ì–‘ ê³„ì‚° í…ŒìŠ¤íŠ¸
    const xv=12.6, yv=1.2; const cnt=Math.floor((xv+1e-9)/yv); const rem=Math.round((xv-cnt*yv)*100)/100; assert('ë‚¨ëŠ” ì–‘(12.6, 1.2)', cnt===10 && Math.abs(rem-0.6)<1e-9, `cnt=${cnt}, rem=${rem}`);

    out.textContent = lines.join('\n');
  }

  // ====== ê³µìœ /ë­í‚¹ ìœ í‹¸ (í´ë¼ì´ì–¸íŠ¸ ì „ìš©) ======
  // êµì‚¬ìš© ì„¤ì •: ì—¬ê¸°ì— ì›¹ì•± URLì„ 1íšŒë§Œ ì„¤ì •í•˜ë©´ í•™ìƒë“¤ì€ URLì„ ë³¼ í•„ìš”/ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.
  const SUBMIT_URL = 'https://script.google.com/macros/s/AKfycby1PUfMRfH0dcECTmWN-6F9uL-jhHZZx9O_jOAHANKd-z0SQBw56oVLh1rUoItBz7h3/exec';// Google Apps Script Web App URL
  const LIST_URL   = 'https://script.google.com/macros/s/AKfycby1PUfMRfH0dcECTmWN-6F9uL-jhHZZx9O_jOAHANKd-z0SQBw56oVLh1rUoItBz7h3/exec';// same URL handles GET

  const STORE_KEY = 'rpg_divdec_settings_v1';
  const MOCK_KEY = 'rpg_divdec_mockrank_v1';

  function saveSettings(){
    const o={ name: document.getElementById('nameInput')?.value||'' };
    localStorage.setItem(STORE_KEY, JSON.stringify(o));
    updateShareNote();
  }
  function loadSettings(){
    try{ const raw=localStorage.getItem(STORE_KEY); if(!raw) return; const o=JSON.parse(raw);
      if(o.name) document.getElementById('nameInput').value=o.name;
    }catch(e){}
    updateShareNote();
  }
  function updateShareNote(){
    const hasRemote = !!(SUBMIT_URL && LIST_URL);
    setText('#shareNote', hasRemote? 'ì˜¨ë¼ì¸ ëª¨ë“œ: ì œì¶œ/ë­í‚¹ì´ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì™€ ë™ê¸°í™”ë©ë‹ˆë‹¤.' : 'ì˜¤í”„ë¼ì¸(ë¡œì»¬ ëª¨ì˜ ë­í‚¹) ëª¨ë“œ: ì½”ë“œ ìƒë‹¨ URL ì„¤ì • í•„ìš”');
  }

  function currentStageNumeric(){ return state.stage.world*10 + state.stage.index; }

  // í˜„ì¬ ìƒíƒœ â†’ 4ê°€ì§€ ì ìˆ˜ë¥¼ ëª¨ë‘ ì‚°ì¶œ
  function getAllScores(){
    return {
      correct: state.totalCorrect||0,
      level: state.level,
      xp: state.xp,
      stage: currentStageNumeric()
    };
  }

  function fmtStage(n){ const w=Math.floor(n/10), i=n%10; return w+'-'+i; }

  // í‘œ ê·¸ë¦¬ê¸°: 4ê°€ì§€ ì ìˆ˜ ëª¨ë‘ ë…¸ì¶œ
  // í‘œ ê·¸ë¦¬ê¸°: 4ê°€ì§€ ì ìˆ˜ ëª¨ë‘ ë…¸ì¶œ (targetIdë¡œ í‘œë¥¼ ì–´ë””ì— ê·¸ë¦´ì§€ ì§€ì •)
function renderRanking(list, targetId = 'ranking'){
  const box = document.getElementById(targetId); if(!box) return;
  if(!list || !list.length){
    box.innerHTML = '<span class="muted">ë­í‚¹ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
    return;
  }

  // ì •ë ¬(ì„œë²„ë„ ì •ë ¬í•˜ì§€ë§Œ, í´ë¼ì—ì„œ í•œ ë²ˆ ë” ì•ˆì „ ì •ë ¬)
  list = [...list].sort((a,b)=>
    ((Number(b.correct)||0) - (Number(a.correct)||0)) ||
    (new Date(b.timestamp) - new Date(a.timestamp))
  );

  // ë™ì¼ ì´ë¦„ ì¤‘ë³µ ì œê±°(ìµœìƒìœ„ë§Œ ìœ ì§€)
  const seen = new Set(); const dedup = [];
  for(const r of list){
    const nm = (r.name||'').trim(); if(!nm) continue;
    if(seen.has(nm)) continue;
    seen.add(nm); dedup.push(r);
  }

  // í‘œ ìƒì„±
  let rows = '';
  dedup.forEach((r,idx)=>{
    const when = r.timestamp ? new Date(r.timestamp).toLocaleString() : '';
    const stageTxt = (typeof r.stage === 'number') ? fmtStage(r.stage) : (r.stageText || '');
    rows += `<tr>
      <td style="padding:6px 4px">${idx+1}</td>
      <td style="padding:6px 4px">${r.name||''}</td>
      <td style="padding:6px 4px">${r.correct ?? r.score ?? ''}</td>
      <td style="padding:6px 4px">${r.level ?? ''}</td>
      <td style="padding:6px 4px">${r.xp ?? ''}</td>
      <td style="padding:6px 4px">${stageTxt}</td>
      <td style="padding:6px 4px">${when}</td>
    </tr>`;
  });

  const header = `
    <table style="width:100%; border-collapse:collapse">
      <thead>
        <tr style="text-align:left">
          <th style="padding:6px 4px">#</th>
          <th style="padding:6px 4px">ì´ë¦„</th>
          <th style="padding:6px 4px">ì •ë‹µìˆ˜</th>
          <th style="padding:6px 4px">ë ˆë²¨</th>
          <th style="padding:6px 4px">ê²½í—˜ì¹˜</th>
          <th style="padding:6px 4px">ìŠ¤í…Œì´ì§€</th>
          <th style="padding:6px 4px">ë“±ë¡ì‹œê°</th>
        </tr>
      </thead>`;

  // ëª¨ë‹¬(targetId='rankingModal')ì€ 5ì¤„ë§Œ ë³´ì´ë„ë¡ ìŠ¤í¬ë¡¤ ë˜í¼
  if(targetId === 'rankingModal'){
    box.innerHTML = header + `<tbody></tbody></table>
      <div style="max-height:160px; overflow:auto">
        <table style="width:100%; border-collapse:collapse"><tbody>${rows}</tbody></table>
      </div>`;
  } else {
    box.innerHTML = header + `<tbody>${rows}</tbody></table>`;
  }
}

async function sendScore(){
  const name = document.getElementById('nameInput')?.value?.trim();
  if(!name){ log('ì´ë¦„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }

  const scores = getAllScores();
  const payload = {
    name,
    ...scores, // correct, level, xp, stage
    stageText: state.stage.world+'-'+state.stage.index,
    timestamp: new Date().toISOString()
  };

  if(!(SUBMIT_URL)){
    addMockRecord(payload); log('ë¡œì»¬ ëª¨ë“œ: ì ìˆ˜ê°€ ì„ì‹œ ë­í‚¹ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    renderRanking(getMockRanking()); return;
  }

  // 1ì°¨: application/json (í‘œì¤€, CORS preflight ë°œìƒ)
  try{
    const res = await fetch(SUBMIT_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    // ì¼ë¶€ í™˜ê²½ì—ì„œ opaque/ë¹„ì •ìƒ ì½”ë“œë¥¼ ëŒë ¤ì¤„ ìˆ˜ë„ ìˆìœ¼ë‹ˆ JSON íŒŒì‹±ë§Œ ì‹œë„
    const data = await res.json().catch(()=>({ok:true}));
    if(!res.ok || data?.ok === false){ throw new Error(data?.message || ('HTTP '+res.status)); }
    log('ì ìˆ˜ ì „ì†¡ ì™„ë£Œ (json)'); 
    renderRanking(await fetchRanking());
    return;
  }catch(e){
    log('json ì „ì†¡ ì‹¤íŒ¨ â†’ text/plainìœ¼ë¡œ ì¬ì‹œë„: '+e.message);
  }

  // 2ì°¨: text/plain (preflight íšŒí”¼ìš© â€œsimple requestâ€)
  try{
    const res = await fetch(SUBMIT_URL, {
      method:'POST',
      headers:{ 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(()=>({ok:true}));
    if(!res.ok || data?.ok === false){ throw new Error(data?.message || ('HTTP '+res.status)); }
    log('ì ìˆ˜ ì „ì†¡ ì™„ë£Œ (text/plain)'); 
    renderRanking(await fetchRanking());
    return;
  }catch(e){
    log('text ì „ì†¡ ì‹¤íŒ¨ â†’ no-corsë¡œ ìµœì¢… ì¬ì‹œë„: '+e.message);
  }

  // 3ì°¨(ìµœí›„): no-cors (ì‘ë‹µì„ ì½ì„ ìˆ˜ ì—†ì§€ë§Œ ì„œë²„ë¡œëŠ” ì „ì†¡ë¨)
  try{
    await fetch(SUBMIT_URL, {
      method:'POST',
      mode:'no-cors',
      headers:{ 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify(payload)
    });
    // ì‘ë‹µì„ í™•ì¸í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, ë‚™ê´€ ì²˜ë¦¬ + ë¡œì»¬ì—ë„ ë°±ì—…
    addMockRecord(payload);
    log('ì ìˆ˜ ì „ì†¡ ì‹œë„(no-cors). ì„œë²„ ì‘ë‹µì€ í™•ì¸ ë¶ˆê°€í•˜ë¯€ë¡œ ë¡œì»¬ì—ë„ ì €ì¥í–ˆìŠµë‹ˆë‹¤.');
  }catch(e){
    log('ì „ì†¡ ì‹¤íŒ¨ - '+e.message+' (ë¡œì»¬ ëª¨ë“œë¡œ ì €ì¥)'); 
    addMockRecord(payload);
  }

  renderRanking(await fetchRanking());
}

  async function fetchRanking(){
  if(!(LIST_URL)) return dedupByName(getMockRanking());
  try {
    const res = await fetch(LIST_URL, { method: 'GET' });
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    let arr = null;
    if(Array.isArray(data)) arr = data;
    else if(data && Array.isArray(data.data)) arr = data.data;
    else if(data && Array.isArray(data.rows)) arr = data.rows;
    else if(data && data.ok === false) throw new Error(data.message || 'ok:false');
    else throw new Error('Unexpected JSON shape');

    const by = 'correct';
    arr.sort((a,b)=> ((Number(b[by])||0) - (Number(a[by])||0)) || (new Date(b.timestamp) - new Date(a.timestamp)) );
    return dedupByName(arr);
  } catch(e) {
    log('ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ - ' + e.message + ' (ë¡œì»¬ ëª¨ë“œ ì‚¬ìš©)');
    return dedupByName(getMockRanking());
  }
}

function dedupByName(list){
  const seen = new Set();
  const out = [];
  for(const r of list){
    const name = (r.name||'').trim();
    if(!name) continue;
    if(seen.has(name)) continue;
    seen.add(name);
    out.push(r);
  }
  return out;
}

  // ëˆ„ì  ì •ë‹µìˆ˜ ì§‘ê³„ ë° í›…
  state.totalCorrect = 0;
  const __finalize = finalize; // ê¸°ì¡´ ì°¸ì¡° ë³´ê´€
  finalize = function(correct, msg){ if(correct){ state.totalCorrect = (state.totalCorrect||0) + 1; } __finalize(correct, msg); }

  // UI ë°”ì¸ë”© í™•ì¥
  const __bindUI = bindUI;
  bindUI = function(){
    __bindUI();
    ['nameInput','rankBy'].forEach(id=>{
      const el=document.getElementById(id); if(el){ el.addEventListener('change', saveSettings); el.addEventListener('blur', saveSettings); }
    });
    // ê¸°ì¤€ ë³€ê²½ ì‹œ ì¦‰ì‹œ ë­í‚¹ ì¬ì¡°íšŒ
    };

function stageName(idx){
    switch(idx){
      case 1: return 'ìë¦¿ìˆ˜ê°€ ê°™ì€ ì†Œìˆ˜ì˜ ë‚˜ëˆ—ì…ˆ';
      case 2: return 'ìë¦¿ìˆ˜ê°€ ë‹¤ë¥¸ ì†Œìˆ˜ì˜ ë‚˜ëˆ—ì…ˆ';
      case 3: return 'ìì—°ìˆ˜ ë‚˜ëˆ„ê¸° ì†Œìˆ˜';
      case 4: return 'ëª«ì„ ë°˜ì˜¬ë¦¼í•˜ì—¬ ë‚˜íƒ€ë‚´ê¸°';
      case 5: return 'ë‚˜ëˆ ì£¼ê³  ë‚¨ëŠ” ì–‘ êµ¬í•˜ê¸°';
      default: return '';
    }
  }
  function updateStageBanner(){
    const el=document.getElementById('stageBanner'); if(!el) return;
    if(state.freeplay){ el.textContent='[ììœ  ì—°ìŠµ ëª¨ë“œ]'; return; }
    const w=state.stage.world, i=state.stage.index; const label=stageName(i);
    el.textContent = `[ìŠ¤í…Œì´ì§€ ${w}-${i} ${label}]`;
  }
  function renderStageSteps(){
    const ul=document.getElementById('stageSteps'); if(!ul) return;
    const items=[...ul.children];
    items.forEach((li,i)=>{ if(i < state.stage.index) li.classList.add('active'); else li.classList.remove('active'); });
  }

window.addEventListener('DOMContentLoaded', async ()=>{
  try{
    renderBars();           // UI ì²« ë Œë”
    newMonster();           // ëª¬ìŠ¤í„° ìƒì„±
    safeNextProblem();      // ë¬¸ì œ ìƒì„±(ê°•í•œ ê°€ë“œ)
    bindUI();               // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    loadSettings();         // ì´ë¦„ ë“± ë¡œì»¬ ì„¤ì •
    renderRanking(await fetchRanking()); // ë­í‚¹
  }catch(e){
    log('ë¶€íŒ… ì˜¤ë¥˜: '+(e?.message||e));
    // ìµœí›„ í´ë°± ë¬¸ì œ
    setText('#question','1.2 Ã· 0.3');
    state.problem = { text:'1.2 Ã· 0.3', ans:4, hint:'ì œìˆ˜ë¥¼ ì •ìˆ˜ë¡œ ë§Œë“¤ê¸°', kind:'number' };
  }
});

    // ì „ì—­ ì˜¤ë¥˜ ë¡œê¹…: ë¬¸ì œ ìƒì„± ì¤‘ ì—ëŸ¬ë¥¼ í™”ë©´ ë¡œê·¸ë¡œ í‘œì‹œ
  window.addEventListener('error', (e)=>{ try{ log('ì˜¤ë¥˜: '+(e?.message||'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜')); }catch(_){} });
</script>
  
</body>
</html>




